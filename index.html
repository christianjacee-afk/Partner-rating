<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TiffanyTinx</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Jost:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* Base Styles matching the image */
:root {
    --primary-red: #ff0055; 
    --border-glow: #ff5599; 
    --dark-bg: rgba(15, 0, 15, 0.95);
    --gold-coin: #FFD700;
    --clean-bg: #1c001c; /* Slightly lighter inner background */
}

body{
  background:radial-gradient(circle at top,#2b0000,#000);
  color:#eee;
  font-family:'Jost', sans-serif; /* Clean font from the image */
  padding:20px;
  min-height: 150vh; 
  padding-bottom: 100px;
}
.container{
  max-width:820px;
  margin:auto;
  background: var(--clean-bg);
  padding:30px;
  border-radius:28px;
  border:4px solid var(--primary-red);
  box-shadow:0 0 40px var(--border-glow), inset 0 0 10px rgba(255, 0, 85, 0.5);
  position: relative;
  z-index: 10;
}
h1{
  font-family:'Cinzel', serif; /* Use Cinzel for a bold title look */
  text-align:center;
  font-size:3.5em; /* Adjusted size to match image */
  color:var(--primary-red);
  text-shadow:0 0 25px var(--border-glow);
  margin-bottom: 30px;
}
label{margin-top:10px;display:block;color:#ff99c2; font-weight: 600;} 

input,select,textarea{
  width:100%;
  padding:12px; 
  background:#100010; /* Very dark input field */
  border:1px solid #333;
  color:#fff;
  border-radius:10px;
  transition: all 0.3s;
  font-family: inherit;
}
input:focus, select:focus, textarea:focus {
    border-color: var(--primary-red);
    box-shadow: 0 0 5px var(--border-glow);
}

/* --- SAVE BUTTON ANIMATION KEYFRAMES --- */
@keyframes bounce { /* (Kept original bounce) */
    0%, 100%, 20%, 50%, 80% { transform: translateY(0); }
    40% { transform: translateY(-5px); }
    60% { transform: translateY(-2px); }
}
#saveBtn{
  margin-top:25px; 
  padding:18px;
  width:100%;
  border:none;
  border-radius:10px; /* Squared off look like image */
  background:linear-gradient(to top, #8f0030, var(--primary-red));
  font-size:1.2em;
  font-weight:bold;
  color:#fff; 
  cursor:pointer;
  box-shadow:0 5px #5c0020,0 0 20px var(--border-glow);
  transition: all 0.1s;
}
#saveBtn:hover {
    background: linear-gradient(to top, #ff0055, #ff5599);
}
#saveBtn:active{
    transform:translateY(5px);
    box-shadow:0 0 #5c0020, 0 0 10px var(--primary-red);
    animation: bounce 0.5s;
}

/* --- Tinx Claim Button Styling --- */
.tinx-claim-style {
    margin-top: 15px !important;
    padding: 12px;
    background: #FFD700 !important;
    color: #000 !important;
    border-radius: 8px !important;
    font-weight: 700 !important;
}

/* --- Tinx Prize Ready Alert Animation --- */
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0.7); transform: scale(1); }
    70% { box-shadow: 0 0 0 15px rgba(255, 255, 0, 0); transform: scale(1.05); }
    100% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); transform: scale(1); }
}
.prize-ready-pulse {
    animation: pulse 1.5s infinite;
    background: #FFD700 !important; 
}
#tinxToggle {
    right: 90px;
    background: var(--primary-red);
}

.rating{
  margin-top:25px; 
  padding:20px;
  border-radius:10px; /* Less rounded corners */
  background:#222;
  border:1px solid #444;
  box-shadow:0 0 8px rgba(255,0,85,.4);
}
.stars{color:gold;font-size:1.2em}

/* --- Toggles and Panels --- */
.secret-toggle{
  position:fixed;
  bottom:20px;
  width:60px;height:60px;
  border-radius:50%;
  background:var(--primary-red);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.6em;
  cursor:pointer;
  box-shadow:0 0 25px var(--border-glow);
  z-index: 100;
  transition: transform 0.2s;
}
.secret-toggle:hover { transform: scale(1.1) rotate(5deg); }
#adminToggle{right:20px} 

.panel{
  position:fixed;
  bottom:95px;
  right:20px;
  background: var(--clean-bg);
  padding:18px;
  border-radius:15px;
  border:2px solid var(--primary-red);
  display:none;
  width:320px; /* Slightly wider panel like the image */
  z-index: 99;
  box-shadow: 0 0 15px var(--border-glow);
}
#tinxPanel{right:90px}

button{
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:18px;
  background:var(--primary-red);
  font-weight:bold;
  cursor:pointer;
  display: block;
  width: 100%;
  color: #fff;
}
.rating button {
    margin-top: 5px;
    background: #444;
    color: #eee;
    border: 1px solid var(--primary-red);
}
.rating button:hover {
    background: var(--primary-red);
    color: #000;
}

/* --- ANIMATION STYLES --- */
/* Potato Explosion uses emoji now */
.potato-explosion {
  position: fixed; 
  inset: 0;
  z-index: 9999;
  background-color: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10em;
  color: #ff9900;
  animation: explode 3s ease-out forwards;
}
.potato-explosion::before {
  content: 'ðŸ¥”'; /* Reinstated Potato Emoji */
  animation: potato-jiggle 0.1s infinite;
  text-shadow: 0 0 50px rgba(255, 153, 0, 0.8), 0 0 100px rgba(255, 69, 0, 0.5);
}
@keyframes explode {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(3); opacity: 0.8; }
  100% { transform: scale(10); opacity: 0; }
}
@keyframes potato-jiggle {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(5deg); }
  50% { transform: rotate(-5deg); }
  75% { transform: rotate(5deg); }
  100% { transform: rotate(-0deg); }
}


/* --- TOKEN/PRIZE SYSTEM STYLES --- */
#tokenDisplay {
    margin-top: 30px;
    padding-top: 20px; 
    border-top: 1px solid var(--primary-red); 
    display: flex;
    flex-wrap: wrap; /* Allow wrapping */
    justify-content: space-around; 
    align-items: flex-start;
    gap: 20px;
}
#individualTokenPile {
    font-size: 1.1em; 
    min-width: 250px; 
    text-align: center;
    padding: 10px;
    background: #250025;
    border: 1px solid #444;
    border-radius: 10px;
}
#bundleDisplay {
    font-size: 1.1em;
    min-width: 250px;
    padding: 10px;
    background: #250025;
    border: 1px solid #444;
    border-radius: 10px;
}
.token-section {
    padding: 10px;
    border-bottom: 1px solid #444;
    margin-bottom: 10px;
}
.token-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

/* Stacked Meter Styles */
@keyframes coinPulse { /* New Keyframe for individual coins */
    0% { transform: scale(1); }
    50% { transform: scale(1.1); box-shadow: 0 0 8px var(--gold-coin); }
    100% { transform: scale(1); }
}
.slot-meter {
    display: flex;
    justify-content: center;
    gap: 8px; 
    margin-top: 10px;
    min-height: 40px; /* Ensure visual space */
}
.coin-slot {
    font-size: 2.2em;
    color: #333; 
    filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
}
.coin-slot.filled {
    color: var(--gold-coin);
    filter: drop-shadow(0 0 8px var(--gold-coin));
}
.coin-slot.pulsing {
    animation: coinPulse 0.6s ease-out; /* Apply pulse animation */
}


.token-bundle-icon {
    font-size: 2.2em; 
    margin: 0 5px;
    display: inline-block;
}
/* Meatball Cloud Style (Ready Exchange) */
.meatball-cloud-icon {
    color: #ffcc00; 
    filter: drop-shadow(0 0 5px #ff0055); 
}
/* Banked Prize Style */
.banked-prize-icon {
    color: #00ff00; /* Green for banked/collected prizes */
    filter: drop-shadow(0 0 5px #00ff00);
}
</style>
</head>

<body>

<div class="container">
<h1>TiffanyTinx</h1>

<label>Name</label>
<input id="name" placeholder="Anonymous Submitter">

<label>Character</label>
<select id="character">
  <option value="Pim">Pim</option>
  <option value="Charlie">Charlie</option>
  <option value="Glep">Glep</option>
  <option value="Mr Boss">Mr Boss</option>
</select>

<label>Stars</label>
<select id="stars">
  <option value="1">1</option><option value="2">2</option>
  <option value="3">3</option><option value="4">4</option>
  <option value="5">5</option>
</select>

<label>PP Energy</label>
<select id="pp">
  <option value="1">1</option><option value="2">2</option>
  <option value="3">3</option><option value="4">4</option>
  <option value="5">5</option><option value="6">6</option>
  <option value="7">7</option><option value="8">8</option>
  <option value="9">9</option><option value="10">10</option>
</select>

<label>Comment</label>
<textarea id="review"></textarea>

<button id="saveBtn"><i class="fas fa-hand-lizard"></i> SUBMIT RATING</button>

<div id="list"></div>

<div id="tokenDisplay" style="display: none;">
    <div id="individualTokenPile"></div>
    <div id="bundleDisplay"></div>
</div>

</div>

<div id="adminToggle" class="secret-toggle"><i class="fas fa-wrench"></i></div> 
<div id="tinxToggle" class="secret-toggle"><i class="fas fa-trophy"></i></div> 

<div id="adminPanel" class="panel">
  <label>Moderator Password</label>
  <input type="password" id="adminPass">
  <button id="adminLogin">Login</button>
  <p id="adminStatus"></p>
  
  <div id="adminTools" style="display:none; margin-top: 15px; border-top: 1px solid var(--primary-red); padding-top: 10px;">
    <p style="color: #ff99c2; font-weight: bold; margin-bottom: 5px;">Prize Point Control</p>
    <button onclick="adminToggleTokenStatus('add')"><i class="fas fa-plus"></i> Add New Prize Point</button>
    <button onclick="adminToggleTokenStatus('remove')"><i class="fas fa-minus"></i> Remove Oldest Prize Point</button>
  </div>
</div>

<div id="tinxPanel" class="panel">
  <label>Tinx Password</label>
  <input type="password" id="tinxPass">
  <button id="tinxClaimLogin">LOGIN / CHECK PRIZES</button> 
  
  <button id="tinxClaimBtn" class="tinx-claim-style" style="display: none;">CLAIM AVAILABLE PRIZES</button>
  <p id="tinxStatus"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC7srqV5cigcYZEdGIW5O8jl-LoA5nNECk",
  authDomain:"tiffanytinx-bbf9c.firebaseapp.com",
  databaseURL:"https://tiffanytinx-bbf9c-default-rtdb.firebaseio.com",
  projectId:"tiffanytinx-bbf9c"
});

const db=firebase.database();
const ref=db.ref("ratings");

// --- CONFIGURATION CONSTANTS ---
const MODERATOR_PASSWORD="ppeanile";
const TINX_PASSWORD="tinxrules"; 
const PRIZE_BUNDLE_SIZE = 5;

let isAdmin=false;
let isTinxLoggedIn=false; 

// --- UTILITY FUNCTIONS ---
function potatoExplosion(){ 
  const f=document.createElement("div");
  f.className="potato-explosion";
  document.body.appendChild(f);
  setTimeout(()=>f.remove(), 3000); 
}

function spawnBloodBubble() {
    const b = document.createElement("div");
    b.className = "bubble";
    const size = Math.random() * 80 + 40; 
    b.style.width = `${size}px`;
    b.style.height = `${size}px`;
    b.style.left = `${Math.random() * 100}vw`; 
    b.style.top = `${Math.random() * 100}vh`; 

    document.body.appendChild(b);
    setTimeout(() => b.remove(), 4000); 
}
setInterval(spawnBloodBubble, 2500); 


// --- TOGGLE HANDLERS ---
adminToggle.onclick=()=>adminPanel.style.display=adminPanel.style.display==="block"?"none":"block";
tinxToggle.onclick=()=>{
    tinxToggle.classList.remove('prize-ready-pulse');
    tinxPanel.style.display=tinxPanel.style.display==="block"?"none":"block";
    document.getElementById('tinxClaimBtn').style.display = 'none'; // Hide claim button until login
    document.getElementById('tinxClaimLogin').style.display = 'block';
    document.getElementById('tokenDisplay').style.display = 'none'; 
    isTinxLoggedIn = false;
};

// --- LOGIN LOGIC (Moderator) ---
adminLogin.onclick=()=>{
  if(adminPass.value===MODERATOR_PASSWORD){
    isAdmin=true;
    adminStatus.textContent="Moderator Enabled";
    adminStatus.style.color = "#00ff00";
    adminTools.style.display = "block";
    render();
    adminPanel.style.display="none";
  } else {
    adminStatus.textContent="Incorrect Password";
    adminStatus.style.color = "#ff0000";
  }
};


// --- TINX LOGIN / CHECK PRIZES LOGIC ---
document.getElementById('tinxClaimLogin').onclick = () => {
    const password = tinxPass.value;
    if (password !== TINX_PASSWORD) {
        tinxStatus.textContent = "Incorrect Tinx Password.";
        tinxStatus.style.color = "#ff0000";
        document.getElementById('tokenDisplay').style.display = 'none'; 
        isTinxLoggedIn = false;
        document.getElementById('tinxClaimBtn').style.display = 'none';
        return;
    }

    // SUCCESSFUL LOGIN
    document.getElementById('tokenDisplay').style.display = 'flex'; 
    isTinxLoggedIn = true;
    tinxToggle.classList.remove('prize-ready-pulse'); 
    
    // Check if bundles are ready to determine button visibility
    ref.orderByChild('token').equalTo(true).once('value', snapshot => {
        let unclaimedTokensCount = 0;
        snapshot.forEach(child => {
            if (child.val().token && !child.val().claimed) {
                unclaimedTokensCount++;
            }
        });

        const unclaimedBundlesReady = Math.floor(unclaimedTokensCount / PRIZE_BUNDLE_SIZE);

        if (unclaimedBundlesReady >= 1) {
            document.getElementById('tinxClaimBtn').style.display = 'block';
            document.getElementById('tinxClaimBtn').textContent = `CLAIM ${unclaimedBundlesReady} AVAILABLE PRIZE(S)`;
            tinxStatus.textContent = `${unclaimedBundlesReady} prize bundle(s) ready to claim.`;
        } else {
            document.getElementById('tinxClaimBtn').style.display = 'none';
            tinxStatus.textContent = `No new prize bundles ready. ${unclaimedTokensCount} points collected.`;
        }
        tinxStatus.style.color = "#ff99c2";
    });
};


// --- TINX CLAIM LOGIC (Moves Unclaimed to Banked) ---
tinxClaimBtn.onclick = () => {
    tinxStatus.textContent = "Processing claim...";
    tinxStatus.style.color = "#ff99c2";
    
    // 1. Get ALL unclaimed token keys
    ref.orderByChild('token').equalTo(true).once('value', snapshot => {
        const unclaimedTokenKeys = [];
        snapshot.forEach(child => {
            if (child.val().token && !child.val().claimed) {
                unclaimedTokenKeys.push(child.key);
            }
        });

        const unclaimedBundlesReady = Math.floor(unclaimedTokenKeys.length / PRIZE_BUNDLE_SIZE);

        if (unclaimedBundlesReady >= 1) {
            
            // CONFIRMATION DIALOG
            if (!confirm(`Are you sure you want to bank ${unclaimedBundlesReady} Meatball Cloud(s)?`)) {
                tinxStatus.textContent = "Claiming cancelled.";
                return;
            }

            // 2. Update the claimed status of only the tokens required for the bundles
            const updates = {};
            const tokensToClaim = unclaimedBundlesReady * PRIZE_BUNDLE_SIZE; 
            for (let i = 0; i < tokensToClaim; i++) {
                updates[unclaimedTokenKeys[i] + '/claimed'] = true;
            }
            
            db.ref('ratings').update(updates).then(() => {
                tinxStatus.textContent = `SUCCESS! ${unclaimedBundlesReady} bundle(s) moved to Banked Prizes.`;
                tinxStatus.style.color = "#00ff00";
                tinxPass.value = '';
                potatoExplosion(); 
                document.getElementById('tinxClaimBtn').style.display = 'none'; // Hide claim button after success
                render(); // Re-render to update the banked count
            }).catch(error => {
                tinxStatus.textContent = "Error claiming prize: " + error.message;
                tinxStatus.style.color = "#ff0000";
            });

        } else {
            tinxStatus.textContent = `No prize bundles available to claim.`;
            tinxStatus.style.color = "#ff0000";
            document.getElementById('tinxClaimBtn').style.display = 'none';
        }
    });
};

// --- SAVE RATING LOGIC ---
saveBtn.onclick=()=>{
  const s=parseInt(stars.value);
  ref.push({
    name:name.value||"Anonymous",
    character:character.value,
    stars:s,
    pp:parseInt(pp.value),
    review:review.value,
    token: s===5, 
    claimed: s===5 ? false : null,
    time:Date.now()
  });
  if(s===5) potatoExplosion(); 
  name.value="";review.value="";
};


// --- TOKEN VISUALS (Stacked Slot Meter & Alerts) ---
function updateTokenDisplay(unclaimedCount, claimedCount) {
    const individualPileElement = document.getElementById('individualTokenPile');
    const bundleDisplayElement = document.getElementById('bundleDisplay');
    
    individualPileElement.innerHTML = '';
    bundleDisplayElement.innerHTML = '';
    
    const currentCoins = unclaimedCount % PRIZE_BUNDLE_SIZE;
    const unclaimedBundlesReady = Math.floor(unclaimedCount / PRIZE_BUNDLE_SIZE);
    const claimedBundlesFinal = Math.floor(claimedCount / PRIZE_BUNDLE_SIZE);

    // 1. PRIZE READY ALERT (Tinx Toggle Pulse)
    if (unclaimedBundlesReady > 0 && !isTinxLoggedIn) {
         tinxToggle.classList.add('prize-ready-pulse');
    } else {
         tinxToggle.classList.remove('prize-ready-pulse');
    }


    // 2. STACKED SLOT METER (with pulsing feature)
    let meterHTML = `<div class="token-section"><h3>Prize Point Accumulation</h3>`;
    meterHTML += `<div class="slot-meter">`;
    for (let i = 0; i < PRIZE_BUNDLE_SIZE; i++) {
        const isFilled = i < currentCoins ? 'filled' : '';
        // Apply pulsing class to the newest coin (the one at index currentCoins - 1)
        const isPulsing = (i === currentCoins - 1) ? 'pulsing' : ''; 
        meterHTML += `<span class="coin-slot ${isFilled} ${isPulsing}"><i class="fas fa-coins"></i></span>`;
    }
    meterHTML += `</div></div>`;
    individualPileElement.innerHTML = meterHTML;


    // 3. BUNDLE DISPLAY (Split into Ready and Banked)
    let bundlesHTML = '<div class="token-section"><h3>Ready Exchanges (Unclaimed)</h3>';
    
    // Render UNCLAIMED bundles (Meatball Clouds)
    if (unclaimedBundlesReady === 0) {
        bundlesHTML += `<p style="opacity: 0.7;">No Meatball Clouds available.</p>`;
    } else {
        for (let i = 0; i < unclaimedBundlesReady; i++) {
            bundlesHTML += `<span class="token-bundle-icon meatball-cloud-icon" title="Ready to Claim!"><i class="fas fa-cloud-meatball"></i></span>`;
        }
    }
    bundlesHTML += '</div>';

    // RENDER CLAIMED bundles (Banked Prizes)
    bundlesHTML += '<div class="token-section"><h3>Banked Prizes (Claimed)</h3>';
    if (claimedBundlesFinal === 0) {
        bundlesHTML += `<p style="opacity: 0.7;">The bank is empty!</p>`;
    } else {
        for (let i = 0; i < claimedBundlesFinal; i++) {
            // Use the trophy icon for the Banked Prize
            bundlesHTML += `<span class="token-bundle-icon banked-prize-icon" title="Banked Prize"><i class="fas fa-trophy"></i></span>`;
        }
    }
    bundlesHTML += '</div>';
    
    bundleDisplayElement.innerHTML = bundlesHTML;
}

// --- RENDER FUNCTION (Unchanged except for updateTokenDisplay call) ---
window.del=id=>isAdmin&&confirm("Delete?")&&ref.child(id).remove();
window.editRating=(id,r)=>{
  if(!isAdmin) return;
  const n=prompt("Name:",r.name)||r.name;
  const c=prompt("Character:",r.character)||r.character;
  const s=parseInt(prompt("Stars:",r.stars))||r.stars;
  const p=parseInt(prompt("PP:",r.pp))||r.pp;
  const rev=prompt("Comment:",r.review)||r.review;
  ref.child(id).update({name:n,character:c,stars:s,pp:p,review:rev});
};

function render(){
  let unclaimedTokenCount = 0;
  let claimedTokenCount = 0;

  ref.limitToLast(25).once("value",snap=>{
    list.innerHTML="";
    
    snap.forEach(c => {
        const r = c.val();
        
        if (r.token) {
            if (r.claimed) {
                claimedTokenCount++;
            } else {
                unclaimedTokenCount++;
            }
        }
        
        const d=document.createElement("div");
        d.className="rating";
        
        const tokenStatus = r.token 
            ? `<span style="color:${r.claimed?'#555':'#ff9900'}; font-weight:bold; margin-left: 10px;">ðŸ’° Prize Point: ${r.claimed?"BANKED":"AVAILABLE"}</span>`
            : '';

        const tokenToggleBtn = r.token 
            ? `<button onclick="adminSetToken('${c.key}', false)"><i class="fas fa-minus"></i> Remove Point</button>` 
            : `<button onclick="adminSetToken('${c.key}', true)"><i class="fas fa-plus"></i> Add Point</button>`;
        
        d.innerHTML=`
            <b>${r.name}</b> (${r.character}) ${tokenStatus}<br>
            <span class="stars">${"â˜…".repeat(r.stars)}</span><br>
            PP: ${r.pp}<br>
            ${r.review||""}<br>
            ${isAdmin?`
            <br>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="editRating('${c.key}',${JSON.stringify(r).replace(/"/g,'&quot;')})">Edit Rating</button>
                ${tokenToggleBtn}
            </div>
            <button onclick="del('${c.key}')" style="margin-top: 5px;">Delete Rating</button>`:""}
        `;
        list.prepend(d);
    });
    
    updateTokenDisplay(unclaimedTokenCount, claimedTokenCount);
  });
}

// Initial/real-time render call
ref.on("value",render);
</script>

</body>
</html>
