<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TiffanyTinx</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Jost:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* Base Styles matching the image */
:root {
    --primary-red: #ff0055; 
    --border-glow: #ff5599; 
    --dark-bg: rgba(15, 0, 15, 0.95);
    --gold-coin: #FFD700;
    --clean-bg: #1c001c; 
    --decay-red: #cc0000; /* New color for decaying elements */
}

body{
  background:radial-gradient(circle at top,#2b0000,#000);
  color:#eee;
  font-family:'Jost', sans-serif;
  padding:20px;
  min-height: 150vh; 
  padding-bottom: 100px;
}
.container{
  max-width:820px;
  margin:auto;
  background: var(--clean-bg);
  padding:30px;
  border-radius:28px;
  border:4px solid var(--primary-red);
  box-shadow:0 0 40px var(--border-glow), inset 0 0 10px rgba(255, 0, 85, 0.5);
  position: relative;
  z-index: 10;
}
h1{
  font-family:'Cinzel', serif;
  text-align:center;
  font-size:3.5em; 
  color:var(--primary-red);
  text-shadow:0 0 25px var(--border-glow);
  margin-bottom: 30px;
}
label{margin-top:10px;display:block;color:#ff99c2; font-weight: 600;} 

input,select,textarea{
  width:100%;
  padding:12px; 
  background:#100010; 
  border:1px solid #333;
  color:#fff;
  border-radius:10px;
  transition: all 0.3s;
  font-family: inherit;
}
input:focus, select:focus, textarea:focus {
    border-color: var(--primary-red);
    box-shadow: 0 0 5px var(--border-glow);
}

/* --- SAVE BUTTON ANIMATION KEYFRAMES --- */
@keyframes bounce { 
    0%, 100%, 20%, 50%, 80% { transform: translateY(0); }
    40% { transform: translateY(-5px); }
    60% { transform: translateY(-2px); }
}
#saveBtn{
  margin-top:25px; 
  padding:18px;
  width:100%;
  border:none;
  border-radius:10px; 
  background:linear-gradient(to top, #8f0030, var(--primary-red));
  font-size:1.2em;
  font-weight:bold;
  color:#fff; 
  cursor:pointer;
  box-shadow:0 5px #5c0020,0 0 20px var(--border-glow);
  transition: all 0.1s;
}
#saveBtn:hover { background: linear-gradient(to top, #ff0055, #ff5599); }
#saveBtn:active{
    transform:translateY(5px);
    box-shadow:0 0 #5c0020, 0 0 10px var(--primary-red);
    animation: bounce 0.5s;
}

/* --- Toggles and Panels --- */
.secret-toggle{
  position:fixed;
  bottom:20px;
  width:60px;height:60px;
  border-radius:50%;
  background:var(--primary-red);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.6em;
  cursor:pointer;
  box-shadow:0 0 25px var(--border-glow);
  z-index: 100;
  transition: transform 0.2s;
}
.rating{
  margin-top:25px; 
  padding:20px;
  border-radius:10px; 
  background:#222;
  border:1px solid #444;
  box-shadow:0 0 8px rgba(255,0,85,.4);
  position: relative;
}
.stars{color:gold;font-size:1.2em}
.rating-decaying {
    border: 3px solid var(--decay-red);
    box-shadow: 0 0 15px var(--decay-red), inset 0 0 5px rgba(204, 0, 0, 0.5);
    animation: decayFlash 2s infinite alternate;
}
@keyframes decayFlash {
    from { opacity: 1; }
    to { opacity: 0.8; }
}
.decay-timer {
    font-size: 0.9em;
    color: var(--decay-red);
    font-weight: bold;
    margin-top: 5px;
}

/* Comment Section Styles */
.comment-section {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px dashed #444;
}
.comment-list {
    max-height: 150px;
    overflow-y: auto;
    margin-bottom: 10px;
    padding-right: 5px;
}
.comment-item {
    background: #111;
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 5px;
    font-size: 0.9em;
}
.comment-item strong {
    color: #ff99c2;
    margin-right: 8px;
}
.comment-form input {
    margin-bottom: 5px;
}

/* --- FLAMING POTATO SPRITE ANIMATION --- */
@keyframes walk {
    0% { transform: translateX(0); }
    100% { transform: translateX(100vw); }
}
.sprite {
    position: fixed;
    bottom: 0;
    left: -100px; 
    font-size: 3em; 
    animation: walk 18s linear infinite; 
    z-index: 999;
    line-height: 0; 
    filter: drop-shadow(0 0 10px orange); 
}
.sprite::before {
    content: 'ðŸ¥”ðŸ”¥'; 
}
</style>
</head>

<body>
<audio id="themeSong" loop preload="auto">
    <source src="https://assets.mixkit.co/sfx/download/mixkit-dramatic-droning-low-fx-3211.wav" type="audio/wav">
    Your browser does not support the audio element.
</audio>

<audio id="sfx5Star" preload="auto">
    <source src="https://assets.mixkit.co/sfx/download/mixkit-achievement-bell-600.wav" type="audio/wav">
</audio>
<audio id="sfx1Star" preload="auto">
    <source src="https://assets.mixkit.co/sfx/download/mixkit-sad-trombone-malfunction-1025.wav" type="audio/wav">
</audio>
<audio id="sfxClaim" preload="auto">
    <source src="https://assets.mixkit.co/sfx/download/mixkit-coin-collect-in-a-video-game-2067.wav" type="audio/wav">
</audio>

<div class="sprite"></div>

<div class="container">
<h1>TiffanyTinx</h1>

<label>Name</label>
<input id="name" placeholder="Anonymous Submitter">

<label>Character</label>
<select id="character">
  <option value="Pim">Pim</option>
  <option value="Charlie">Charlie</option>
  <option value="Glep">Glep</option>
  <option value="Mr Boss">Mr Boss</option>
</select>

<label>Stars</label>
<select id="stars">
  <option value="1">1</option><option value="2">2</option>
  <option value="3">3</option><option value="4">4</option>
  <option value="5">5</option>
</select>

<label>PP Energy</label>
<select id="pp">
  <option value="1">1</option><option value="2">2</option>
  <option value="3">3</option><option value="4">4</option>
  <option value="5">5</option><option value="6">6</option>
  <option value="7">7</option><option value="8">8</option>
  <option value="9">9</option><option value="10">10</option>
</select>

<label>Comment</label>
<textarea id="review"></textarea>

<button id="saveBtn"><i class="fas fa-hand-lizard"></i> SUBMIT RATING</button>

<div id="list"></div>

<div id="tokenDisplay" style="display: none;">
    <div id="individualTokenPile"></div>
    <div id="bundleDisplay"></div>
</div>

</div>

<div id="adminToggle" class="secret-toggle"><i class="fas fa-wrench"></i></div> 
<div id="tinxToggle" class="secret-toggle"><i class="fas fa-trophy"></i></div> 

<div id="adminPanel" class="panel">
    <label>Moderator Password</label>
    <input type="password" id="adminPass">
    <button id="adminLogin">Login</button>
    <p id="adminStatus"></p>
    
    <div id="adminTools" style="display:none; margin-top: 15px; border-top: 1px solid var(--primary-red); padding-top: 10px;">
        <p style="color: #ff99c2; font-weight: bold; margin-bottom: 5px;">Potato Control</p>
        <button onclick="adminToggleTokenStatus('add')"><i class="fas fa-plus"></i> Add New Potato</button>
        <button onclick="adminToggleTokenStatus('remove')"><i class="fas fa-minus"></i> Remove Oldest Potato</button>
    </div>
</div>

<div id="tinxPanel" class="panel">
    <label>Tinx Password</label>
    <input type="password" id="tinxPass">
    <button id="tinxClaimLogin">LOGIN / CHECK POTATOES</button> 
    
    <button id="tinxClaimBtn" class="tinx-claim-style" style="display: none;">CLAIM AVAILABLE POTATOES</button>
    <p id="tinxStatus"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC7srqV5cigcYZEdGIW5O8jl-LoA5nNECk",
  authDomain:"tiffanytinx-bbf9c.firebaseapp.com",
  databaseURL:"https://tiffanytinx-bbf9c-default-rtdb.firebaseio.com",
  projectId:"tiffanytinx-bbf9c"
});

const db=firebase.database();
const ref=db.ref("ratings");

// --- CONFIGURATION CONSTANTS ---
const MODERATOR_PASSWORD="ppeanile";
const TINX_PASSWORD="tinxrules"; 
const PRIZE_BUNDLE_SIZE = 5; 
const DECAY_PERIOD_MS = 1000 * 60 * 60 * 24; // 24 hours decay time (for testing, use 1000 * 60 * 5 for 5 minutes)

let isAdmin=false;
let isTinxLoggedIn=false; 

// --- AUDIO HANDLING ---
const themeSong = document.getElementById('themeSong');
const sfx5Star = document.getElementById('sfx5Star');
const sfx1Star = document.getElementById('sfx1Star');
const sfxClaim = document.getElementById('sfxClaim');

// Start theme song automatically (requires user interaction in most browsers, so we try to play on first click)
document.addEventListener('click', function() {
    if (themeSong.paused) {
        themeSong.volume = 0.3; // Lower the volume
        themeSong.play().catch(e => console.log("Theme song audio failed to play:", e));
    }
}, { once: true });


// --- UTILITY FUNCTIONS (Potato Explosion, Blood Bubble, etc.) ---
function potatoExplosion(){ 
  const f=document.createElement("div");
  f.className="potato-explosion";
  document.body.appendChild(f);
  setTimeout(()=>f.remove(), 3000); 
}
function spawnBloodBubble() {
    const b = document.createElement("div");
    b.className = "bubble";
    const size = Math.random() * 80 + 40; 
    b.style.width = `${size}px`;
    b.style.height = `${size}px`;
    b.style.left = `${Math.random() * 100}vw`; 
    b.style.top = `${Math.random() * 100}vh`; 
    document.body.appendChild(b);
    setTimeout(() => b.remove(), 4000); 
}
setInterval(spawnBloodBubble, 2500); 

// --- DECAY CHECKER AND STABILIZATION ---
function checkAndApplyDecay(ratingKey, rating) {
    if (rating.token && !rating.claimed && !rating.stable) {
        const timeSinceToken = Date.now() - rating.time;
        
        if (timeSinceToken > DECAY_PERIOD_MS) {
            // DECAY ACTION: Remove potato, revert to 4 stars
            ref.child(ratingKey).update({
                token: false,
                claimed: null,
                stable: null,
                stars: 4
            }).then(() => {
                console.log(`Rating ${ratingKey} decayed. Potato removed.`);
                render(); 
            });
        }
    }
}

window.adminStabilize = (id) => {
    if (!isAdmin) {
        alert("You must be logged in as Moderator to stabilize a rating.");
        return;
    }
    ref.child(id).update({ stable: true }).then(() => {
        alert("Rating stabilized! The potato token is safe.");
        render();
    });
};


// --- COMMENTING LOGIC ---
window.submitComment = (ratingKey) => {
    const commentInput = document.getElementById(`commentText_${ratingKey}`);
    const nameInput = document.getElementById(`commentName_${ratingKey}`);
    const commentText = commentInput.value.trim();
    const commenterName = nameInput.value.trim() || "Anonymous";

    if (!commentText) return;

    const newComment = {
        name: commenterName,
        text: commentText,
        time: Date.now()
    };
    
    // Push the comment to the 'comments' array under the specific rating ID
    ref.child(`${ratingKey}/comments`).push(newComment).then(() => {
        commentInput.value = '';
        render(); // Re-render to show new comment
    });
};

// --- TOGGLE HANDLERS (omitted for brevity) ---
adminToggle.onclick=()=>adminPanel.style.display=adminPanel.style.display==="block"?"none":"block";
tinxToggle.onclick=()=>{
    tinxToggle.classList.remove('prize-ready-pulse');
    tinxPanel.style.display=tinxPanel.style.display==="block"?"none":"block";
    document.getElementById('tinxClaimBtn').style.display = 'none';
    document.getElementById('tinxClaimLogin').style.display = 'block';
    document.getElementById('tokenDisplay').style.display = 'none'; 
    isTinxLoggedIn = false;
};

// --- LOGIN/ADMIN LOGIC (omitted for brevity) ---
adminLogin.onclick=()=>{
  if(adminPass.value===MODERATOR_PASSWORD){
    isAdmin=true;
    adminStatus.textContent="Moderator Enabled";
    adminStatus.style.color = "#00ff00";
    adminTools.style.display = "block";
    render();
    adminPanel.style.display="none";
  } else {
    adminStatus.textContent="Incorrect Password";
    adminStatus.style.color = "#ff0000";
  }
};
// ... (adminSetToken and adminToggleTokenStatus remain the same) ...
// ... (tinxClaimLogin and tinxClaimBtn remain the same) ...


// --- SAVE RATING LOGIC (with SFX and Decay Initialization) ---
saveBtn.onclick=()=>{
  const s=parseInt(stars.value);
  const data = {
    name:name.value||"Anonymous",
    character:character.value,
    stars:s,
    pp:parseInt(pp.value),
    review:review.value,
    token: s===5, 
    claimed: s===5 ? false : null,
    stable: s===5 ? false : null, // All 5-star tokens start UNSTABLE
    time:Date.now()
  };

  ref.push(data).then(() => {
    if(s===5) {
      potatoExplosion(); 
      sfx5Star.currentTime = 0; sfx5Star.play();
    } else if (s===1) {
      sfx1Star.currentTime = 0; sfx1Star.play();
    }
  });

  name.value="";review.value="";
};


// --- TOKEN VISUALS (omitted for brevity) ---
function updateTokenDisplay(unclaimedCount, claimedCount) {
    const individualPileElement = document.getElementById('individualTokenPile');
    const bundleDisplayElement = document.getElementById('bundleDisplay');
    individualPileElement.innerHTML = '';
    bundleDisplayElement.innerHTML = '';
    const unclaimedReadyCount = unclaimedCount; 
    const bankedCount = claimedCount;

    if (unclaimedReadyCount > 0 && !isTinxLoggedIn) {
         tinxToggle.classList.add('prize-ready-pulse');
    } else {
         tinxToggle.classList.remove('prize-ready-pulse');
    }

    let meterHTML = `<div class="token-section"><h3>Unbanked Potato Accumulation</h3>`;
    meterHTML += `<div class="slot-meter">`;
    for (let i = 0; i < PRIZE_BUNDLE_SIZE; i++) {
        const isFilled = (unclaimedCount > i); 
        const isPulsing = (unclaimedCount > 0 && i === unclaimedCount - 1) ? 'pulsing' : ''; 
        let iconHtml = 'ðŸ¥”';
        let colorClass = isFilled ? 'filled' : '';
        meterHTML += `<span class="coin-slot ${colorClass} ${isPulsing}">${iconHtml}</span>`;
    }
    meterHTML += `</div>`;
    meterHTML += `<p>Total Unbanked: ${unclaimedReadyCount}</p>`;
    meterHTML += `</div>`;
    individualPileElement.innerHTML = meterHTML;

    let bundlesHTML = '<div class="token-section"><h3>Banked Potatoes</h3>';
    if (bankedCount === 0) {
        bundlesHTML += `<p style="opacity: 0.7;">The potato bank is empty!</p>`;
    } else {
        bundlesHTML += `<p style="font-size: 2.5em; margin: 10px 0; color: #00ff00;">${bankedCount} ðŸ¥”</p>`;
    }
    bundlesHTML += '</div>';
    bundleDisplayElement.innerHTML = bundlesHTML;
}


// --- RENDER FUNCTION (Decay/Comment Integration) ---
window.del=id=>isAdmin&&confirm("Delete?")&&ref.child(id).remove();
window.editRating=(id,r)=>{
  if(!isAdmin) return;
  const n=prompt("Name:",r.name)||r.name;
  const c=prompt("Character:",r.character)||r.character;
  const s=parseInt(prompt("Stars:",r.stars))||r.stars;
  const p=parseInt(prompt("PP:",r.pp))||r.pp;
  const rev=prompt("Comment:",r.review)||r.review;
  ref.child(id).update({name:n,character:c,stars:s,pp:p,review:rev});
};


function render(){
  let unclaimedTokenCount = 0;
  let claimedTokenCount = 0;

  ref.limitToLast(25).once("value",snap=>{
    list.innerHTML="";
    
    snap.forEach(c => {
        const r = c.val();
        const ratingKey = c.key;
        
        // --- DECAY CHECKER EXECUTION ---
        checkAndApplyDecay(ratingKey, r);

        if (r.token) {
            if (r.claimed) {
                claimedTokenCount++;
            } else {
                unclaimedTokenCount++;
            }
        }
        
        const d=document.createElement("div");
        d.className="rating";
        
        // --- DECAY VISUALS ---
        let decayInfo = '';
        let decayClass = '';
        if (r.token && !r.claimed && !r.stable) {
            decayClass = 'rating-decaying';
            const timeRemaining = DECAY_PERIOD_MS - (Date.now() - r.time);
            const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            
            if (timeRemaining > 0) {
                decayInfo = `<p class="decay-timer"><i class="fas fa-exclamation-triangle"></i> Decaying! Time Left: ${hours}h ${minutes}m</p>`;
            } else {
                decayInfo = `<p class="decay-timer"><i class="fas fa-skull-crossbones"></i> DECAY IMMINENT!</p>`;
            }
        }
        d.classList.add(decayClass);
        
        // --- TOKEN DISPLAY (Disappears when claimed) ---
        let tokenIcon = '';
        if (r.token && !r.claimed) {
            tokenIcon = `<span class="token-icon-display" style="color: #ff9900;">ðŸ¥”</span>`;
        }
        
        // --- COMMENT RENDERING ---
        let commentsHTML = '';
        let commentCount = 0;
        if (r.comments) {
            const commentsArray = [];
            for (let key in r.comments) {
                commentsArray.push(r.comments[key]);
            }
            commentsArray.sort((a, b) => b.time - a.time); // Newest first
            commentCount = commentsArray.length;

            let listHTML = '';
            commentsArray.forEach(c => {
                listHTML += `<div class="comment-item"><strong>${c.name}</strong>: ${c.text}</div>`;
            });

            commentsHTML = `
                <div class="comment-section">
                    <details>
                        <summary>Comments (${commentCount})</summary>
                        <div class="comment-list">${listHTML}</div>
                        <div class="comment-form">
                            <input type="text" id="commentName_${ratingKey}" placeholder="Your Name" style="width: 40%; display: inline-block;">
                            <input type="text" id="commentText_${ratingKey}" placeholder="Add a comment..." style="width: 55%; display: inline-block;">
                            <button onclick="submitComment('${ratingKey}')" style="display: block; width: 100%; margin-top: 5px;">Post Comment</button>
                        </div>
                    </details>
                </div>
            `;
        }

        // --- RATING CARD HTML ---
        const moderatorDecayBtn = (r.token && !r.claimed && !r.stable && isAdmin)
            ? `<button onclick="adminStabilize('${ratingKey}')" style="background: #38b000; margin-top: 5px;"><i class="fas fa-shield-alt"></i> STABILIZE</button>`
            : '';

        const tokenToggleBtn = r.token 
            ? `<button onclick="adminSetToken('${ratingKey}', false)"><i class="fas fa-minus"></i> Remove Potato</button>` 
            : `<button onclick="adminSetToken('${ratingKey}', true)"><i class="fas fa-plus"></i> Add Potato</button>`;
        
        d.innerHTML=`
            <b>${r.name}</b> (${r.character}) ${tokenIcon}<br>
            <span class="stars">${"â˜…".repeat(r.stars)}</span><br>
            PP: ${r.pp}<br>
            ${r.review||""}
            ${decayInfo}
            ${isAdmin?`
            <br>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="editRating('${ratingKey}',${JSON.stringify(r).replace(/"/g,'&quot;')})">Edit Rating</button>
                ${tokenToggleBtn}
            </div>
            ${moderatorDecayBtn}
            <button onclick="del('${ratingKey}')" style="margin-top: 5px;">Delete Rating</button>`:""}
            ${commentsHTML}
        `;
        list.prepend(d);
    });
    
    updateTokenDisplay(unclaimedTokenCount, claimedTokenCount);
  });
}

// Initial/real-time render call
ref.on("value",render);
</script>

</body>
</html>
