<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TiffanyTinx Ratings - The Vault</title>

<link href="https://fonts.googleapis.com/css2?family=Metal+Mania&family=Cinzel:wght=400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* Base Styles */
body{
  background:radial-gradient(circle at top,#2b0000,#000);
  color:#eee;
  font-family:'Cinzel',serif;
  padding:20px;
  min-height: 100vh;
  padding-bottom: 100px; /* Space for the fixed controls */
}
.container{
  max-width:820px;
  margin:auto;
  background:rgba(15,15,15,.95);
  padding:30px;
  border-radius:28px;
  border:3px solid #ff3b3b;
  box-shadow:0 0 30px rgba(255,0,0,.7);
}
h1{
  font-family:'Metal Mania',cursive;
  text-align:center;
  font-size:4.8em;
  color:#ff3b3b;
  text-shadow:0 0 20px red;
}
label{margin-top:16px;display:block;color:#ffb3b3}
input,select,textarea{
  width:100%;
  padding:12px;
  background:#1b1b1b;
  border:2px solid #ff3b3b;
  color:#fff;
  border-radius:20px;
}
#saveBtn{
  margin-top:25px;
  padding:18px;
  width:100%;
  border:none;
  border-radius:35px;
  background:linear-gradient(#ff5555,#990000);
  font-size:1.3em;
  font-weight:bold;
  color:#000;
  cursor:pointer;
  box-shadow:0 10px #550000,0 0 30px red;
}
#saveBtn:active{transform:translateY(10px);box-shadow:none}

.rating{
  margin-top:22px;
  padding:18px;
  border-radius:22px;
  background:#222;
  border:2px solid #ff3b3b;
  box-shadow:0 0 15px rgba(255,0,0,.4);
}
.stars{color:gold;font-size:1.2em}

.secret-toggle{
  position:fixed;
  bottom:20px;
  width:60px;height:60px;
  border-radius:50%;
  background:#ff3b3b;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.6em;
  cursor:pointer;
  box-shadow:0 0 25px red;
  z-index: 100;
}
#adminToggle{right:20px}
#tinxToggle{right:90px;background:#ff66cc}

.panel{
  position:fixed;
  bottom:95px;
  right:20px;
  background:#2a0000;
  padding:18px;
  border-radius:20px;
  border:2px solid #ff3b3b;
  display:none;
  width:260px;
  z-index: 99;
}
#tinxPanel{right:90px}

button{
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:18px;
  background:#ff3b3b;
  font-weight:bold;
  cursor:pointer;
  display: block; /* Make sure buttons take full width */
  width: 100%;
  text-align: center;
}
.panel button {
    margin-top: 5px;
}

/* ðŸ”¥ FULLSCREEN FLAME */
.flame{
  position:fixed;
  inset:0;
  z-index:9999;
  background:radial-gradient(circle at 50% 85%,#fff,#ff0,#ff4500,#8b0000,transparent);
  animation:rise 2s ease-out forwards;
}
@keyframes rise{
  from{opacity:0;transform:translateY(100%)}
  25%{opacity:1}
  to{opacity:0;transform:translateY(-100%)}
}

/* --- TOKEN SYSTEM STYLES --- */
#tokenDisplay {
    margin-top: 50px;
    padding: 20px 0;
    border-top: 2px solid #ffcc00;
    text-align: center;
    font-size: 1.8em;
    color: #ffcc00;
}
.token-icon {
    margin: 0 8px;
    display: inline-block;
}
.token-individual {
    font-size: 1em;
    color: #ccc;
    position: relative;
    padding: 0 5px;
}
.token-individual .token-base {
    color: #666;
    font-size: 1.6em;
}
.token-individual .token-powder {
    color: #fff; 
    font-size: 0.6em;
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); 
}
.token-bundle {
    font-size: 2.5em;
    color: #ffcc00;
    margin: 0 15px;
    border-right: 2px solid #444;
    padding-right: 15px;
}
.token-bundle:last-child {
    border-right: none;
    padding-right: 0;
}
.token-bundle-claimed {
    color: #444;
}
</style>
</head>

<body>

<div class="container">
<h1>TiffanyTinx</h1>

<label>Name</label>
<input id="name" placeholder="Anonymous">

<label>Character</label>
<select id="character">
  <option value="Pim">Pim</option>
  <option value="Charlie">Charlie</option>
  <option value="Glep">Glep</option>
  <option value="Mr Boss">Mr Boss</option>
</select>

<label>Stars</label>
<select id="stars">
  <option value="1">1</option><option value="2">2</option>
  <option value="3">3</option><option value="4">4</option>
  <option value="5">5</option>
</select>

<label>PP Energy</label>
<select id="pp">
  <option value="1">1</option><option value="2">2</option>
  <option value="3">3</option><option value="4">4</option>
  <option value="5">5</option><option value="6">6</option>
  <option value="7">7</option><option value="8">8</option>
  <option value="9">9</option><option value="10">10</option>
</select>

<label>Comment</label>
<textarea id="review"></textarea>

<button id="saveBtn"><i class="fas fa-heart"></i> SAVE RATING</button>

<div id="list"></div>

<div id="tokenDisplay">
    <span id="sackIcons"></span>
</div>

</div>

<div id="adminToggle" class="secret-toggle"><i class="fas fa-anchor"></i></div>
<div id="tinxToggle" class="secret-toggle"><i class="fas fa-gift"></i></div>

<div id="adminPanel" class="panel">
  <label>Admin Password</label>
  <input type="password" id="adminPass">
  <button id="adminLogin">Login</button>
  <p id="adminStatus"></p>
  
  <div id="adminTools" style="display:none; margin-top: 15px; border-top: 1px solid #ff3b3b; padding-top: 10px;">
    <p style="color: #ffb3b3; font-weight: bold; margin-bottom: 5px;">Token Control</p>
    <button onclick="adminToggleTokenStatus('add')"><i class="fas fa-plus"></i> Add Token</button>
    <button onclick="adminToggleTokenStatus('remove')"><i class="fas fa-minus"></i> Remove Token</button>
  </div>
</div>

<div id="tinxPanel" class="panel">
  <label>Tinx Password</label>
  <input type="password" id="tinxPass">
  <button id="tinxClaimBtn">Claim Bundle</button> 
  <p id="tinxStatus"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC7srqV5cigcYZEdGIW5O8jl-LoA5nNECk",
  authDomain:"tiffanytinx-bbf9c.firebaseapp.com",
  databaseURL:"https://tiffanytinx-bbf9c-default-rtdb.firebaseio.com",
  projectId:"tiffanytinx-bbf9c"
});

const db=firebase.database();
const ref=db.ref("ratings");

// --- CONFIGURATION CONSTANTS ---
const ADMIN_PASSWORD="ppeanile";
const TINX_PASSWORD="tinxrules"; 
const TOKEN_BUNDLE_SIZE = 5;

let isAdmin=false,isTinx=false;

// --- TOGGLE HANDLERS ---
adminToggle.onclick=()=>adminPanel.style.display=adminPanel.style.display==="block"?"none":"block";
tinxToggle.onclick=()=>tinxPanel.style.display=tinxPanel.style.display==="block"?"none":"block";

// --- LOGIN LOGIC ---
adminLogin.onclick=()=>{
  if(adminPass.value===ADMIN_PASSWORD){
    isAdmin=true;
    adminStatus.textContent="Admin enabled";
    adminStatus.style.color = "#00ff00";
    adminTools.style.display = "block"; // Show the token controls
    render();
    adminPanel.style.display="none";
  } else {
    adminStatus.textContent="Incorrect Password";
    adminStatus.style.color = "#ff0000";
  }
};

// --- NEW ADMIN TOKEN CONTROL FUNCTION ---
window.adminToggleTokenStatus = (action) => {
    if (!isAdmin) {
        alert("You must be logged in as Admin to use this tool.");
        return;
    }
    
    // 1. Find the oldest unclaimed token
    if (action === 'remove') {
        ref.orderByChild('token').equalTo(true).once('value', snapshot => {
            let targetKey = null;
            snapshot.forEach(child => {
                const r = child.val();
                // Find the first UNCLAIMED token (oldest one)
                if (!r.claimed) {
                    targetKey = child.key;
                    return true; // Break the loop
                }
            });
            
            if (targetKey) {
                // To "remove" a token, we set its 'token' flag to false
                ref.child(targetKey).update({token: false, claimed: undefined}).then(() => {
                    alert("Oldest unclaimed token removed!");
                    render();
                });
            } else {
                alert("No unclaimed tokens found to remove.");
            }
        });
    
    // 2. Add a new token (Simulate a 5-star rating post)
    } else if (action === 'add') {
         // This simulates adding a new 5-star rating just for the token effect
        ref.push({
            name: "ADMIN ADDED TOKEN",
            character: "Admin",
            stars: 5,
            pp: 1,
            review: "Manually added token by administrator.",
            token: true, 
            claimed: false, 
            time: Date.now()
        }).then(() => {
            alert("New unclaimed token added!");
            render();
        });
    }
};

// --- TINX CLAIM LOGIC ---
tinxClaimBtn.onclick = () => {
    const password = tinxPass.value;
    if (password !== TINX_PASSWORD) {
        tinxStatus.textContent = "Incorrect Tinx Password.";
        tinxStatus.style.color = "#ff0000";
        return;
    }
    
    tinxStatus.textContent = "Checking for claimable bundles...";
    tinxStatus.style.color = "#ffb3b3";

    ref.orderByChild('token').equalTo(true).once('value', snapshot => {
        const unclaimedTokens = [];
        snapshot.forEach(child => {
            const tokenData = child.val();
            if (!tokenData.claimed) {
                unclaimedTokens.push(child.key);
            }
        });

        if (unclaimedTokens.length >= TOKEN_BUNDLE_SIZE) {
            const updates = {};
            for (let i = 0; i < TOKEN_BUNDLE_SIZE; i++) {
                updates[unclaimedTokens[i] + '/claimed'] = true;
            }
            
            db.ref('ratings').update(updates).then(() => {
                tinxStatus.textContent = `SUCCESS! Claimed ${TOKEN_BUNDLE_SIZE} tokens.`;
                tinxStatus.style.color = "#00ff00";
                tinxPass.value = '';
                render();
            }).catch(error => {
                tinxStatus.textContent = "Error claiming bundle: " + error.message;
                tinxStatus.style.color = "#ff0000";
            });

        } else {
            tinxStatus.textContent = `Failed. Only ${unclaimedTokens.length} of ${TOKEN_BUNDLE_SIZE} tokens available.`;
            tinxStatus.style.color = "#ff0000";
        }
    });
};

function flame(){
  const f=document.createElement("div");
  f.className="flame";
  document.body.appendChild(f);
  setTimeout(()=>f.remove(),2000);
}

// --- SAVE RATING LOGIC ---
saveBtn.onclick=()=>{
  const s=parseInt(stars.value);
  ref.push({
    name:name.value||"Anonymous",
    character:character.value,
    stars:s,
    pp:parseInt(pp.value),
    review:review.value,
    token: s===5, 
    claimed: s===5 ? false : undefined,
    time:Date.now()
  });
  if(s===5) flame();
  name.value="";review.value="";
};

// --- UTILITY/ADMIN FUNCTIONS ---
window.del=id=>isAdmin&&confirm("Delete?")&&ref.child(id).remove();

window.editRating=(id,r)=>{
  if(!isAdmin) return;
  const n=prompt("Name:",r.name)||r.name;
  const c=prompt("Character:",r.character)||r.character;
  const s=parseInt(prompt("Stars:",r.stars))||r.stars;
  const p=parseInt(prompt("PP:",r.pp))||r.pp;
  const rev=prompt("Comment:",r.review)||r.review;
  ref.child(id).update({name:n,character:c,stars:s,pp:p,review:rev});
};

// --- TOKEN VISUALS ---
function renderTokenIcon(isClaimed, isBundle) {
    if (isClaimed) {
        return `<span class="token-icon token-bundle token-bundle-claimed"><i class="fas fa-box-open"></i></span>`;
    }
    if (isBundle) {
        return `<span class="token-icon token-bundle"><i class="fas fa-gift"></i></span>`;
    }
    return `
        <span class="token-icon token-individual">
            <i class="fas fa-bag-shopping token-base"></i>
            <i class="fas fa-circle token-powder"></i>
        </span>
    `;
}

function updateTokenDisplay(unclaimedCount, claimedCount) {
    const sackIconsElement = document.getElementById('sackIcons');
    sackIconsElement.innerHTML = '';
    
    const currentSacks = unclaimedCount % TOKEN_BUNDLE_SIZE;
    
    let bundlesRendered = 0;

    for (let i = 0; i < claimedCount; i++) {
        sackIconsElement.innerHTML += renderTokenIcon(true, true);
        bundlesRendered++;
    }

    for (let i = 0; i < Math.floor(unclaimedCount / TOKEN_BUNDLE_SIZE); i++) {
        sackIconsElement.innerHTML += renderTokenIcon(false, true);
        bundlesRendered++;
    }
    
    if (bundlesRendered > 0 && currentSacks > 0) {
        const separator = document.createElement('span');
        separator.textContent = ' | ';
        sackIconsElement.appendChild(separator);
    }

    for (let i = 0; i < currentSacks; i++) {
        sackIconsElement.innerHTML += renderTokenIcon(false, false);
    }

    if (unclaimedCount === 0 && claimedCount === 0) {
        sackIconsElement.textContent = 'No tokens banked.';
        sackIconsElement.style.fontSize = '1em';
    } else {
        sackIconsElement.style.fontSize = '1.8em';
    }
}


// --- RENDER FUNCTION ---
function render(){
  let unclaimedTokenCount = 0;
  let claimedTokenCount = 0;

  ref.limitToLast(25).once("value",snap=>{
    list.innerHTML="";
    
    snap.forEach(c => {
        const r = c.val();
        
        // COUNT TOKENS
        if (r.token) {
            if (r.claimed) {
                claimedTokenCount++;
            } else {
                unclaimedTokenCount++;
            }
        }
        
        // RENDER RATING LIST ITEM
        const d=document.createElement("div");
        d.className="rating";
        
        const tokenStatus = r.token 
            ? `<span style="color:${r.claimed?'#555':'#fff'}; font-weight:bold; margin-left: 10px;">ðŸŽŸ Token: ${r.claimed?"CLAIMED":"UNCLAIMED"}</span>`
            : '';
        
        d.innerHTML=`
            <b>${r.name}</b> (${r.character}) ${tokenStatus}<br>
            <span class="stars">${"â˜…".repeat(r.stars)}</span><br>
            PP: ${r.pp}<br>
            ${r.review||""}<br>
            ${isAdmin?`
            <br>
            <button onclick="editRating('${c.key}',${JSON.stringify(r).replace(/"/g,'&quot;')})">Edit</button>
            <button onclick="del('${c.key}')">Delete</button>`:""}
        `;
        list.prepend(d);
    });
    
    // UPDATE TOKEN VISUALS
    updateTokenDisplay(unclaimedTokenCount, claimedTokenCount);
  });
}

// Initial/real-time render call
ref.on("value",render);
</script>

</body>
</html>
